# Anoma Protocol Adapter GraphQL Schema
# Entities follow Anoma specification from pa-evm/contracts/src/Types.sol

# ============================================
# Core Anoma Types
# ============================================

# Transaction - The top-level transaction containing actions
# Corresponds to: struct Transaction { Action[] actions; bytes deltaProof; bytes aggregationProof; }
type Transaction {
  id: ID!
  blockNumber: Int!
  logIndex: Int! # EVM event log index of the TransactionExecuted event
  txHash: String!
  timestamp: Int!
  chainId: Int!
  contractAddress: String!

  # EVM transaction fields
  from: String
  value: BigInt
  gasPrice: BigInt
  gas: BigInt
  gasUsed: BigInt

  # From TransactionExecuted event
  tags: [String!]!
  logicRefs: [String!]!

  # Proofs (if available from calldata decoding)
  deltaProof: String
  aggregationProof: String

  # Relationships
  actions: [Action!]! @derivedFrom(field: "transaction")
  resources: [Resource!]! @derivedFrom(field: "transaction")
}

# Action - Provides context separation between non-intersecting sets of resources
# Corresponds to: struct Action { Logic.VerifierInput[] logicVerifierInputs; Compliance.VerifierInput[] complianceVerifierInputs; }
type Action {
  id: ID!
  index: Int!
  actionTreeRoot: String!
  tagCount: Int!
  blockNumber: Int!
  chainId: Int!
  timestamp: Int!

  # Relationships
  transaction: Transaction!
  complianceUnits: [ComplianceUnit!]! @derivedFrom(field: "action")
  logicInputs: [LogicInput!]! @derivedFrom(field: "action")
}

# ComplianceUnit - One consumed + one created resource pair
# Corresponds to: Compliance.VerifierInput { bytes proof; Instance instance; }
type ComplianceUnit {
  id: ID!
  index: Int!

  # Proof
  proof: String

  # Compliance.Instance fields
  # ConsumedRefs
  consumedNullifier: String!
  consumedLogicRef: String!
  consumedCommitmentTreeRoot: String!

  # CreatedRefs
  createdCommitment: String!
  createdLogicRef: String!

  # Delta values (secp256k1 point)
  unitDeltaX: String!
  unitDeltaY: String!

  # Relationships
  action: Action!
  consumedResource: Resource
  createdResource: Resource
}

# LogicInput - Logic verifier input for a resource
# Corresponds to: Logic.VerifierInput { bytes32 tag; bytes32 verifyingKey; AppData appData; bytes proof; }
type LogicInput {
  id: ID!
  index: Int!

  tag: String!
  logicRef: String! # The logic verifying key (same as verifyingKey in PA-EVM)
  isConsumed: Boolean!
  proof: String

  # AppData payload counts
  resourcePayloadCount: Int!
  discoveryPayloadCount: Int!
  externalPayloadCount: Int!
  applicationPayloadCount: Int!

  # Relationships
  action: Action!
  resource: Resource
}

# Resource - A reference to an Anoma resource identified by its tag (nullifier or commitment)
# Note: The full Resource struct fields (labelRef, valueRef, etc.) cannot be populated
# because the ResourcePayload blob format is application-specific.
type Resource {
  id: ID!
  tag: String! # Nullifier (if consumed) or commitment (if created)
  index: Int! # Position in TransactionExecuted.tags array
  blobIndex: Int # Index in ResourcePayload event (if emitted)
  isConsumed: Boolean! # true = nullifier (consumed), false = commitment (created)
  blockNumber: Int!
  chainId: Int!

  # Logic reference from TransactionExecuted.logicRefs
  logicRef: String

  # Raw blob data from ResourcePayload event (if emitted)
  rawBlob: String!
  decodingStatus: String! # "pending" | "raw" | "success" | "failed"
  decodingError: String

  # Relationships
  transaction: Transaction!
  logicInput: LogicInput
  consumedInComplianceUnit: ComplianceUnit
  createdInComplianceUnit: ComplianceUnit
  discoveryPayloads: [DiscoveryPayload!]! @derivedFrom(field: "resource")
  applicationPayloads: [ApplicationPayload!]! @derivedFrom(field: "resource")
}

# ============================================
# Payload Types (from events)
# ============================================

# DiscoveryPayload - Data with public keys for discovery
type DiscoveryPayload {
  id: ID!
  tag: String!
  index: Int!
  blob: String!
  deletionCriterion: Int
  blockNumber: Int!
  chainId: Int!
  timestamp: Int!

  resource: Resource
}

# ExternalPayload - Data for external/forwarder calls
type ExternalPayload {
  id: ID!
  tag: String!
  index: Int!
  blob: String!
  deletionCriterion: Int
  blockNumber: Int!
  chainId: Int!
  timestamp: Int!
}

# ApplicationPayload - Application-specific data
type ApplicationPayload {
  id: ID!
  tag: String!
  index: Int!
  blob: String!
  deletionCriterion: Int
  blockNumber: Int!
  chainId: Int!
  timestamp: Int!

  resource: Resource
}

# ============================================
# State Tracking Types
# ============================================

# CommitmentTreeRoot - Merkle tree root for resource commitments
type CommitmentTreeRoot {
  id: ID!
  root: String!
  blockNumber: Int!
  txHash: String!
  timestamp: Int!
  chainId: Int!
  index: Int!
}

# ForwarderCall - Meta-transaction execution via untrusted forwarder
type ForwarderCall {
  id: ID!
  forwarderAddress: String!
  input: String!
  output: String!
  blockNumber: Int!
  txHash: String!
  timestamp: Int!
  chainId: Int!
}
